<h1>Site Setup.</h1>

<p>Assumes running on Linode - but should translate
Assumes Arch linux - but should translate</p>

<p>The rest of this refers to these three variables. But, the
code fragments won't necessarily work.</p>

<pre><code>export SITE=
export DATABASE=$SITE
export SITE_USER=$SITE
export PASSWORD=&lt;something&gt;
</code></pre>

<h2>Test Driven Site Setup</h2>

<p>The tests/hosts directory contains a bunch of tests which run commands
on hosts - either selected hosts, or all hosts defined in the :hosts role
in the Capfile.</p>

<p>The test parameters may be set by defining environment variables.</p>

<p>For Host Provisioning Testing</p>

<ul>
<li>HOSTS - list of hosts to run tests on. Default is all hosts defined in the
:hosts role of the Capfile</li>
<li>HOST_ADMIN - name of admin user on all hosts (NOT root). Defaults to 'host_admin'</li>
<li>LOCAL_ADMIN - name of admin user on local (maybe development or staging site)
who has the authority to run commands on all hosts. Should be able to ssh into
both HOST_ADMIN and 'root' on all hosts via public key logins. Defaults to
'local_admin'</li>
<li>LOCAL_ADMIN<em>EMAIL - email address of admin who should receive notifications
from all hosts - typically from 'monit'. Defaults to 'local</em>admin@example.com'</li>
</ul>

<p>For site installation testing:</p>

<ul>
<li>SITE - name of site. Should satisfy [a-z][_a-z0-9]*  Defaults to 'site'</li>
<li>SITE_USER - name of user who owns the site and is the owner of the proxied
web servers [mongrel or thin]. Defaults to 'site'</li>
<li>SITE_BASE_PORT - starting port number for proxied servers. Defaults to 8000</li>
<li>SITE_NUM_SERVERS - number of mongrel/thin's to spin up. Default is 3</li>
</ul>

<h2>Create Account</h2>

<p>as HOST_USER</p>

<pre><code>sudo useradd --comment 'admin for $SITE' --user-group --create-home $SITE_USER
sudo mkdir /home/${SITE_USER}/.ssh
sudo cp -R /home/${HOST_ADMIN}/.ssh/authorized_keys /home/${SITE_USER}/.ssh
sudo chown -R ${SITE_USER} /home/${SITE_USER}/.ssh
sudo chmod -R u-w /home/${SITE_USER}/.ssh
sudo chmod -R go-rwx /home/${SITE_USER}/.ssh
</code></pre>

<h2>Create Postgresql User</h2>

<pre><code>echo 'create user $SITE_USER createdb;' | psql postgres postgres

echo &quot;create database $DATABASE with owner $SITE_USER encoding 'utf-8' template template0 ;&quot; | \
    psql postgres postgres
</code></pre>

<h2>as SITE_USER</h2>

<pre><code>chmod 744 .
mkdir sites
mkdir $SITE
sudo chgrp http $SITE sites
sudo chmod 750 $SITE sites
sudo chmod g+s $SITE sites
</code></pre>

<h3>install rvm</h3>

<pre><code>bash &lt; &lt;(curl -s https://rvm.beginrescueend.com/install/rvm)

Note: if rvm fails on 'cannot create /usr/local/bin/rvm', check to see if /etc/rvmrc
exists. If it does, it will be sourced by bash and will attempt a global install.
</code></pre>

<h3>install ruby 1.9.2</h3>

<pre><code>rvm install 1.9.2
(wait)
rvm use 1.9.2 --default

gem install bundler
</code></pre>

<h3>install and configure thin</h3>

<pre><code>SITE_PATH=&lt;absolute path to site&gt;
PORT_BASE=&lt;lowest port number the thin daemons will use&gt;
SERVERS=&lt;number of server daemons to spin up&gt;
</code></pre>

<p>thin config file:</p>

<pre><code>--- 
chdir: $SITE_PATH
environment: production
address: 127.0.0.1
port: $PORT_BASE
timeout: 30
log: log/thin.log
pid: $SITE_PATH/tmp/pids/thin.pid
max_conns: 1024
max_persistent_conns: 512
require: []

wait: 30
servers: $SERVERS
daemonize: true
</code></pre>

<h3>create .monitrc file to manage thin server</h3>

<pre><code>TBD - Steal this from Mike Clark's recipes book


# check $SITE - cobbled from apache check
check file $SITE_bin with path /usr/sbin/$SITE
  if failed md5 checksum and
     expect the sum 869b5a36e7f2d553197675fec58c3917 then stop
  if failed permission 755 then stop
  if failed uid root then stop
  if failed gid root then stop
  alert mike@clove.com on {
        checksum, permission, uid, gid # , unmonitor
    } with the mail-format { subject: &quot;/usr/sbin/$SITE modified &quot; }
  group server

# check $SITE - cobbled from apache check
check file postmaster_bin with path /usr/bin/postmaster
  if failed md5 checksum and
     expect the sum 13704b8f314a0aa92e7d03557595f2de then stop
  if failed permission 755 then stop
  if failed uid root then stop
  if failed gid root then stop
  alert mike@clove.com on {
        checksum, permission, uid, gid # , unmonitor    } with the mail-format { subject: &quot;/usr/sbin/postmaster modified &quot; }
  group server
</code></pre>
