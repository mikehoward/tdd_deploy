# Setup of a Linode Server

## set up ssh access

    add user key to ~root/.ssh/authorized_keys

    edit /etc/ssh/sshd_config
    
    PermitRootLogin yes

    /etc/rc.d/sshd restart  # arch linux
    service ssh restart     # ubuntu linux

    Test ssh root@hostname to make sure it works, then change
    PermitRootLogin without-password


## install packages

As root

    pacman -Su

    pacman -Sy

    pacman -S nginx ruby iptables postgresql

    pacman -R ruby
    

## setup for iptables

    pacman -S iptables # pulls in both iptables and ip6tables
    
These configurations only allow HTTP, HTTPS, and SSH traffic.
The do not work if the dbms is on a separate host or if we need
multiple hosts to do load balancing.

We will resolve this when we need it - hopefully that will coincide
with $$$ to hire it done.
    
### iptables

cd /etc/iptables

    cat <<-EOF >iptables.rules
    # Generated by iptables-save v1.4.10 on Fri Jul  8 04:13:58 2011
    *filter
    :INPUT DROP [0:0]
    :FORWARD DROP [0:0]
    :OUTPUT ACCEPT [1676:404831]
    :TCP - [0:0]
    :UDP - [0:0]
    -A INPUT -i lo -j ACCEPT 
    -A INPUT -m conntrack --ctstate INVALID -j DROP 
    -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
    -A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT 
    -A INPUT -p udp -m conntrack --ctstate NEW -j UDP 
    -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP 
    -A INPUT -p udp -j REJECT --reject-with icmp-port-unreachable 
    -A INPUT -p tcp -j REJECT --reject-with tcp-reset 
    -A INPUT -j REJECT --reject-with icmp-proto-unreachable 
    -A TCP -p tcp -m tcp --dport 22 -j ACCEPT 
    -A TCP -p tcp -m tcp --dport 80 -j ACCEPT 
    -A TCP -p tcp -m tcp --dport 443 -j ACCEPT 
    -A UDP -p udp -m udp --dport 22 -j ACCEPT 
    -A UDP -p udp -m udp --dport 80 -j ACCEPT 
    -A UDP -p udp -m udp --dport 443 -j ACCEPT 
    COMMIT
    # Completed on Fri Jul  8 04:13:58 2011
    EOF

    /etc/rc.d/iptables restart
    /etc/rc.d/iptables save

###  ip6tables

ip6tables has similar, but slightly different syntax. I don't expect
any IPV6 traffic, but there is no reason not to respond and even more
reason not to leave holes open.

cd /etc/iptables

    cat <<-EOF >ip6tables.rules
    # Generated by iptables-save v1.4.10 on Fri Jul  8 04:13:58 2011
    *filter
    :INPUT DROP [0:0]
    :FORWARD DROP [0:0]
    :OUTPUT ACCEPT [1676:404831]
    :TCP - [0:0]
    :UDP - [0:0]
    -A INPUT -i lo -j ACCEPT 
    -A INPUT -m conntrack --ctstate INVALID -j DROP 
    -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
    # echo request
    # this is the ipv4 version
    # -A INPUT -p icmp -m icmp --icmp-type 8 -m conntrack --ctstate NEW -j ACCEPT 
    -A INPUT -p icmpv6 -m icmp6 --icmpv6-type 128 -m conntrack --ctstate NEW -j ACCEPT 
    -A INPUT -p udp -m conntrack --ctstate NEW -j UDP 
    -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -m conntrack --ctstate NEW -j TCP 
    -A INPUT -p udp -j REJECT --reject-with icmp6-port-unreachable 
    -A INPUT -p tcp -j REJECT --reject-with tcp-reset 
    -A INPUT -j REJECT --reject-with adm-prohibited
    -A TCP -p tcp -m tcp --dport 22 -j ACCEPT 
    -A TCP -p tcp -m tcp --dport 80 -j ACCEPT 
    -A TCP -p tcp -m tcp --dport 443 -j ACCEPT 
    -A UDP -p udp -m udp --dport 22 -j ACCEPT 
    -A UDP -p udp -m udp --dport 80 -j ACCEPT 
    -A UDP -p udp -m udp --dport 443 -j ACCEPT 
    COMMIT
    # Completed on Fri Jul  8 04:13:58 2011

## Enable en_US locale

run `locale -a`

if it works, then go to nginx

if not, then

    vim /etc/locale-gen
    (uncomment both en_US lines, save and quit)
    locale-gen
    
    Test with `locale -a`

## set up nginx

    pacman -S nginx

Use this as /etc/nginx/conf/nginx.conf (edit as appropriate)

NOTE: the 'include /home/*/site/*;' line pulls in all the sites
defined in all user directories. The idea is to have one user for
each site so that Capistrano can use distinct Cap files with distinct
users, in case we need to do different things.

    user http;
    worker_processes  6;
    #worker_processes  1;

    #error_log  logs/error.log;
    #error_log  logs/error.log  notice;
    #error_log  logs/error.log  info;

    #pid        logs/nginx.pid;


    events {
        worker_connections  1024;
    }


    http {
        include       mime.types;
        default_type  application/octet-stream;

        #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
        #                  '$status $body_bytes_sent "$http_referer" '
        #                  '"$http_user_agent" "$http_x_forwarded_for"';

        #access_log  logs/access.log  main;

        sendfile        on;
        #tcp_nopush     on;

        #keepalive_timeout  0;
        keepalive_timeout  65;

        #gzip  on;

        server {
            listen       80;
            server_name  localhost;

            #charset koi8-r;

            #access_log  logs/host.access.log  main;

            location / {
                root   html;
                index  index.html index.htm;
            }

            #error_page  404              /404.html;

            # redirect server error pages to the static page /50x.html
            #
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   html;
            }

        }

        # THIS LINE ADDS SITE CONFIGURATION FILES
        include /home/*/site/*;
    }

## install monit (or something like it)

TBD - once I figure it out

    pacman -S monit
    
## install snort

TBD

    pacman -S snort

## set up posgresql

    pacman -S postgresql

    adduser postgres
    mkdir /usr/local/pgsql/data
    chown postgres /usr/local/pgsql/data
    su - postgres
    /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data
    /usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data >logfile 2>&1 &
    /usr/local/pgsql/bin/createdb test
    /usr/local/pgsql/bin/psql test

## Configure boot

NOTE: we probably don't need to start postgresql and nginx when using monitd

add iptables ip6tables postgresql nginx monitd to DAEMONS
    
    cp /etc/rc.conf /etc/rc.conf-orig
    sed -e '/^DAEMONS/{ s/^/# /
      aDAEMONS=(syslog-ng network iptables ip6tables netfs crond sshd postgresql nginx monitd)
      }' \
    /etc/rc.conf-orig >/etc/rc.conf
    cat /etc/rc.conf

## Create user mike

    adduser mike

    (fill in as appropriate)

    chmod 711 /home/mike

    sudo su - mike

    mkdir htdocs
    chgrp nginx htdocs
    chmod 755 htdocs
    chmod g+s htdocs

Add mike to sudoer's

    vi /etc/sudoers
    (add mike as equivalent to root)
    
## As user 'mike'

### install rvm

    bash < <(curl -s https://rvm.beginrescueend.com/install/rvm)

### install ruby 1.9.2

    rvm install 1.9.2
    (wait)
    rvm use 1.9.2 --default
    
    gem install bundler
